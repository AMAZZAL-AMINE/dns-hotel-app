"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.uploadMetadataAsync = void 0;
const tslib_1 = require("tslib");
const events_1 = require("../analytics/events");
const log_1 = tslib_1.__importDefault(require("../log"));
const prompts_1 = require("../prompts");
const tasks_1 = require("./apple/tasks");
const config_1 = require("./config");
const context_1 = require("./context");
const errors_1 = require("./errors");
const telemetry_1 = require("./utils/telemetry");
/**
 * Sync a local store configuration with the stores.
 * Note, only App Store is supported at this time.
 */
async function uploadMetadataAsync(metadataCtx) {
    var _a;
    const storeConfig = await loadConfigWithValidationPromptAsync(metadataCtx);
    const { app, auth } = await (0, context_1.ensureMetadataAppStoreAuthenticatedAsync)(metadataCtx);
    const { unsubscribeTelemetry, executionId } = (0, telemetry_1.subscribeTelemetry)(events_1.MetadataEvent.APPLE_METADATA_UPLOAD, { app, auth });
    log_1.default.addNewLineIfNone();
    log_1.default.log('Uploading App Store configuration...');
    const errors = [];
    const config = (0, config_1.createAppleReader)(storeConfig);
    const tasks = (0, tasks_1.createAppleTasks)(metadataCtx, {
        // We need to resolve a different version as soon as possible.
        // This version is the parent model of all changes we are going to push.
        version: (_a = config.getVersion()) === null || _a === void 0 ? void 0 : _a.versionString,
    });
    const taskCtx = { app };
    for (const task of tasks) {
        try {
            await task.prepareAsync({ context: taskCtx });
        }
        catch (error) {
            errors.push(error);
        }
    }
    for (const task of tasks) {
        try {
            await task.uploadAsync({ config, context: taskCtx });
        }
        catch (error) {
            errors.push(error);
        }
    }
    unsubscribeTelemetry();
    if (errors.length > 0) {
        throw new errors_1.MetadataUploadError(errors, executionId);
    }
    return { appleLink: `https://appstoreconnect.apple.com/apps/${app.id}/appstore` };
}
exports.uploadMetadataAsync = uploadMetadataAsync;
async function loadConfigWithValidationPromptAsync(metadataCtx) {
    try {
        return await (0, config_1.loadConfigAsync)(metadataCtx);
    }
    catch (error) {
        if (error instanceof errors_1.MetadataValidationError) {
            (0, errors_1.logMetadataValidationError)(error);
            log_1.default.newLine();
            log_1.default.warn('Without further updates, the current store configuration can fail to be synchronized with the App Store or pass App Store review.');
            if (await (0, prompts_1.confirmAsync)({ message: 'Do you still want to push the store configuration?' })) {
                return await (0, config_1.loadConfigAsync)({ ...metadataCtx, skipValidation: true });
            }
        }
        throw error;
    }
}
